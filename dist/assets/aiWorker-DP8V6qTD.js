self.onmessage=w=>{const{board:k,difficulty:B,currentPlayer:a}=w.data,P={p:100,n:320,b:330,r:500,q:900,k:2e4},E={pawn:[[0,0,0,0,0,0,0,0],[50,50,50,50,50,50,50,50],[10,10,20,30,30,20,10,10],[5,5,10,25,25,10,5,5],[0,0,0,20,20,0,0,0],[5,-5,-10,0,0,-10,-5,5],[5,10,10,-20,-20,10,10,5],[0,0,0,0,0,0,0,0]],knight:[[-50,-40,-30,-30,-30,-30,-40,-50],[-40,-20,0,0,0,0,-20,-40],[-30,0,10,15,15,10,0,-30],[-30,5,15,20,20,15,5,-30],[-30,0,15,20,20,15,0,-30],[-30,5,10,15,15,10,5,-30],[-40,-20,0,5,5,0,-20,-40],[-50,-40,-30,-30,-30,-30,-40,-50]],bishop:[[-20,-10,-10,-10,-10,-10,-10,-20],[-10,0,0,0,0,0,0,-10],[-10,0,5,10,10,5,0,-10],[-10,5,5,10,10,5,5,-10],[-10,0,10,10,10,10,0,-10],[-10,10,10,10,10,10,10,-10],[-10,5,0,0,0,0,5,-10],[-20,-10,-10,-10,-10,-10,-10,-20]],king:[[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-30,-40,-40,-50,-50,-40,-40,-30],[-20,-30,-30,-40,-40,-30,-30,-20],[-10,-20,-20,-20,-20,-20,-20,-10],[20,20,0,0,0,0,20,20],[20,30,10,0,0,10,30,20]]};function p(n){return n?n===n.toUpperCase()?"red":"blue":null}function q(n,e){return n>=0&&n<8&&e>=0&&e<8}function y(n,e,f,t,s,i,c=!0){if(!n)return!1;const r=n.toLowerCase(),u=p(n);if(!q(t,s)||e===t&&f===s)return!1;const o=i[t][s];if(o&&p(o)===u)return!1;let l=!1;switch(r){case"p":l=K(u,e,f,t,s,i);break;case"r":l=T(e,f,t,s,i);break;case"n":l=x(e,f,t,s);break;case"b":l=A(e,f,t,s,i);break;case"q":l=U(e,f,t,s,i);break;case"k":l=O(u,e,f,t,s);break}return!(!l||c&&W(e,f,t,s,u,i))}function K(n,e,f,t,s,i){const c=n==="blue"?-1:1,r=n==="blue"?6:1,u=t-e,o=s-f;return Math.abs(o)===1&&u===c?i[t][s]&&p(i[t][s])!==n:o!==0||i[t][s]?!1:u===c||e===r&&u===2*c&&!i[e+c][f]}function T(n,e,f,t,s){return n!==f&&e!==t?!1:S(n,e,f,t,s)}function x(n,e,f,t){const s=Math.abs(f-n),i=Math.abs(t-e);return s===2&&i===1||s===1&&i===2}function A(n,e,f,t,s){const i=Math.abs(f-n),c=Math.abs(t-e);return i!==c?!1:S(n,e,f,t,s)}function U(n,e,f,t,s){const i=Math.abs(f-n),c=Math.abs(t-e);return i!==c&&n!==f&&e!==t?!1:S(n,e,f,t,s)}function O(n,e,f,t,s,i){const c=Math.abs(t-e),r=Math.abs(s-f);return c<=1&&r<=1}function S(n,e,f,t,s){const i=Math.sign(f-n)||0,c=Math.sign(t-e)||0;let r=n+i,u=e+c;for(;r!==f||u!==t;){if(s[r][u])return!1;r+=i,u+=c}return!0}function W(n,e,f,t,s,i){const c=i[f][t],r=i[n][e];i[f][t]=r,i[n][e]=null;const u=g(s,i);return i[n][e]=r,i[f][t]=c,u}function g(n,e){const f=n==="blue"?"k":"K";let t,s;for(let i=0;i<8;i++){for(let c=0;c<8;c++)if(e[i][c]===f){t=i,s=c;break}if(t!==void 0)break}return _(t,s,n==="blue"?"red":"blue",e)}function _(n,e,f,t){for(let s=0;s<8;s++)for(let i=0;i<8;i++){const c=t[s][i];if(c&&p(c)===f&&y(c,s,i,n,e,t,!1))return!0}return!1}function L(n,e){const f=[];for(let t=0;t<8;t++)for(let s=0;s<8;s++){const i=e[t][s];if(i&&p(i)===n)for(let c=0;c<8;c++)for(let r=0;r<8;r++)y(i,t,s,c,r,e)&&f.push({piece:i,startRow:t,startCol:s,endRow:c,endCol:r,isCapture:!!e[c][r]})}return f}function G(n,e){var i,c,r;let f=0;const t=e==="red"?"blue":"red",s={[e]:g(e,n),[t]:g(t,n)};for(let u=0;u<8;u++)for(let o=0;o<8;o++){const l=n[u][o];if(l){const H=P[l.toLowerCase()]||0,C=p(l),h=l.toLowerCase(),N=((c=(i=E[h==="p"?"pawn":h==="n"?"knight":h==="b"?"bishop":h==="k"?"king":null])==null?void 0:i[e==="blue"?u:7-u])==null?void 0:c[o])||0;f+=(C===e?1:-1)*(H+N),(u===3||u===4)&&(o===3||o===4)&&(h==="n"||h==="b"||h==="q")&&(f+=C===e?20:-20)}}for(let u=0;u<8;u++){let o=!1;for(let l=0;l<8;l++)if(((r=n[l][u])==null?void 0:r.toLowerCase())==="p"){o=!0;break}if(!o)for(let l=0;l<8;l++)n[l][u]===(e==="blue"?"r":"R")?f+=40:n[l][u]===(e==="blue"?"R":"r")&&(f-=40)}return f+=(s[e]?-50:0)+(s[t]?50:0),f}function V(n,e){const f=e[n.endRow][n.endCol];e[n.endRow][n.endCol]=n.piece,e[n.startRow][n.startCol]=null;const t=g(a==="red"?"blue":"red",e);return e[n.startRow][n.startCol]=n.piece,e[n.endRow][n.endCol]=f,t}function I(n,e,f,t,s,i){const c=n[e.endRow][e.endCol];n[e.endRow][e.endCol]=e.piece,n[e.startRow][e.startCol]=null;let r;if(f===0)r=G(n,a);else{const u=L(t?a==="red"?"blue":"red":a,n);if(u.length===0)r=g(t?a==="red"?"blue":"red":a,n)?t?-1e4:1e4:0;else if(t){r=-1/0;for(const o of u){const l=I(n,o,f-1,!1,s,i);if(l>=1e4)return n[e.startRow][e.startCol]=e.piece,n[e.endRow][e.endCol]=c,l;if(r=Math.max(r,l),s=Math.max(s,r),i<=s)break}}else{r=1/0;for(const o of u){const l=I(n,o,f-1,!0,s,i);if(l<=-1e4)return n[e.startRow][e.startCol]=e.piece,n[e.endRow][e.endCol]=c,l;if(r=Math.min(r,l),i=Math.min(i,r),i<=s)break}}}return n[e.startRow][e.startCol]=e.piece,n[e.endRow][e.endCol]=c,r}const M=L(a,k);if(M.length===0){self.postMessage(null);return}M.sort((n,e)=>{var s,i;const f=(n.isCapture&&P[(s=k[n.endRow][n.endCol])==null?void 0:s.toLowerCase()]||0)+(V(n,k)?100:0);return(e.isCapture&&P[(i=k[e.endRow][e.endCol])==null?void 0:i.toLowerCase()]||0)+(V(e,k)?100:0)-f});let D=null;if(B==="hard"){let n=-1/0;const e=-1/0,f=1/0;for(const t of M){const s=k.map(c=>[...c]),i=I(s,t,2,!1,e,f);i>n&&(n=i,D=t)}}else D=M[Math.floor(Math.random()*M.length)];self.postMessage(D||M[0])};
